name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 当推送 v* 标签时触发（如 v1.0.0）
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write

jobs:
  build:
    name: Build for Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install musl-tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl
          profile: minimal
          override: true
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build frontend
        run: |
          cd web
          npm install
          npm run build
          cd ..
      
      - name: Build backend
        run: cargo build --release --target x86_64-unknown-linux-musl
      
      - name: Create release package
        run: |
          mkdir -p release/calc24
          cp target/x86_64-unknown-linux-musl/release/calc24 release/calc24/
          cp -r web/dist release/calc24/web/
          cp calc24.service release/calc24/
          cp README.md release/calc24/
          cd release
          tar -czf calc24-linux-x86_64-musl.tar.gz calc24/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: calc24-linux-x86_64-musl
          path: release/calc24-linux-x86_64-musl.tar.gz
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: release/calc24-linux-x86_64-musl.tar.gz
          body: |
            ## 算24点 Linux 版本 (静态链接)
            
            此版本使用 musl libc 静态链接，可以在任何 Linux 发行版上运行（包括旧版本 CentOS/Ubuntu）。
            
            ### 安装步骤
            
            ```bash
            # 1. 下载并解压
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/calc24-linux-x86_64-musl.tar.gz
            tar -xzf calc24-linux-x86_64-musl.tar.gz
            cd calc24
            
            # 2. 运行
            ./calc24
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
